# ⚙️ 配置指南

## 📝 环境变量配置

### 方法一：创建 .env 文件（推荐）

在项目根目录创建 `.env` 文件：

```bash
# 在项目根目录（ai_agent/）创建
DEEPSEEK_API_KEY=sk-your-api-key-here
DEEPSEEK_BASE_URL=https://api.deepseek.com
```

### 方法二：PowerShell 临时环境变量

每次启动终端时设置（仅当前会话有效）：

```powershell
$env:DEEPSEEK_API_KEY = "sk-your-api-key-here"
$env:DEEPSEEK_BASE_URL = "https://api.deepseek.com"
```

### 方法三：系统环境变量（永久）

**Windows:**

1. 打开"系统属性" → "环境变量"
2. 在"用户变量"中点击"新建"
3. 变量名：`DEEPSEEK_API_KEY`
4. 变量值：你的 API Key
5. 点击"确定"保存

**Linux/Mac:**

编辑 `~/.bashrc` 或 `~/.zshrc`：

```bash
export DEEPSEEK_API_KEY="sk-your-api-key-here"
export DEEPSEEK_BASE_URL="https://api.deepseek.com"
```

然后执行：
```bash
source ~/.bashrc  # 或 source ~/.zshrc
```

---

## 🔑 获取 DeepSeek API Key

1. 访问：https://platform.deepseek.com/
2. 注册/登录账号
3. 进入"API Keys"页面
4. 点击"Create API Key"
5. 复制生成的 Key（格式：`sk-xxxxxxxxxxxxxxxx`）

---

## 🌐 API 网关配置（可选）

如果你使用代理或自定义网关：

```bash
# 例如使用国内中转服务
DEEPSEEK_BASE_URL=https://your-proxy-domain.com/v1
```

**注意：** 确保你的代理服务支持 DeepSeek API 格式。

---

## 📦 Python 依赖安装

### 完整安装

```bash
cd backend
pip install -r requirements.txt
```

### 分步安装（如遇问题）

```bash
# 1. 核心框架
pip install fastapi==0.110.0 uvicorn==0.29.0

# 2. HTTP 客户端
pip install httpx==0.27.0

# 3. 数据库
pip install sqlalchemy==2.0.28

# 4. 向量数据库
pip install chromadb==0.5.5

# 5. 文本处理
pip install pypdf==4.1.0 python-multipart==0.0.9

# 6. 嵌入模型（较大，约 500MB）
pip install sentence-transformers>=3.0.0 torch

# 7. 网页解析
pip install beautifulsoup4==4.12.3 lxml==5.1.0
```

---

## 🔍 验证配置

### 1. 检查环境变量

**PowerShell:**
```powershell
echo $env:DEEPSEEK_API_KEY
```

**Linux/Mac:**
```bash
echo $DEEPSEEK_API_KEY
```

### 2. 检查依赖安装

```bash
pip list | grep -E "(fastapi|chromadb|sentence)"
```

应该看到：
```
chromadb          0.5.5
fastapi           0.110.0
sentence-transformers  3.x.x
```

### 3. 测试服务启动

```bash
cd backend
python -m uvicorn app.main:app --reload
```

看到以下输出表示成功：
```
INFO:     Uvicorn running on http://127.0.0.1:8000
INFO:     Application startup complete.
```

---

## 🐛 常见配置问题

### 问题 1：找不到 API Key

**错误信息：**
```
ValueError: DEEPSEEK_API_KEY environment variable not set
```

**解决方案：**
1. 检查环境变量是否设置
2. 确保变量名拼写正确（区分大小写）
3. 重启终端使配置生效
4. 如果使用 .env 文件，确保文件在项目根目录

### 问题 2：API 调用失败

**错误信息：**
```
httpx.ConnectError: Connection refused
```

**解决方案：**
1. 检查网络连接
2. 验证 API Key 是否有效
3. 检查 `DEEPSEEK_BASE_URL` 是否正确
4. 尝试在浏览器访问 API 端点

### 问题 3：模型下载失败

**错误信息：**
```
OSError: Can't load tokenizer for 'sentence-transformers/...'
```

**解决方案：**
1. 检查网络连接（需要访问 HuggingFace）
2. 使用国内镜像：
```bash
export HF_ENDPOINT=https://hf-mirror.com
```
3. 手动下载模型后放到缓存目录

### 问题 4：端口被占用

**错误信息：**
```
OSError: [Errno 48] Address already in use
```

**解决方案：**

**Windows:**
```powershell
# 查找占用 8000 端口的进程
netstat -ano | findstr :8000

# 杀掉进程（替换 PID）
taskkill /F /PID <进程ID>
```

**Linux/Mac:**
```bash
# 查找占用 8000 端口的进程
lsof -i :8000

# 杀掉进程
kill -9 <PID>
```

或者使用脚本：
```powershell
# Windows
.\启动服务器.ps1  # 会自动清理端口
```

---

## 📂 数据目录说明

服务首次启动时会自动创建以下目录：

```
backend/data/
├── agent.db          # SQLite 数据库（对话、文档、工具记录）
├── chroma/           # 向量数据库（文档嵌入）
├── uploads/          # 用户上传的文档
├── notes/            # AI 生成的笔记
└── diagrams/         # AI 生成的图表
```

**注意：** 这些目录已在 `.gitignore` 中，不会提交到 Git。

---

## 🔒 安全建议

1. **永远不要提交 .env 文件到 Git**
   - `.env` 已在 `.gitignore` 中
   - 如果不小心提交了，立即 revoke API Key

2. **API Key 权限控制**
   - 在 DeepSeek 控制台设置 API Key 的使用限额
   - 定期轮换 API Key

3. **生产环境**
   - 使用系统环境变量而非 .env 文件
   - 考虑使用密钥管理服务（如 AWS Secrets Manager）

---

## 🚀 快速检查清单

启动服务前确保：

- [ ] Python 3.10+ 已安装
- [ ] 已创建虚拟环境（conda 或 venv）
- [ ] 已激活虚拟环境
- [ ] 已安装所有依赖（`pip install -r requirements.txt`）
- [ ] 已设置 `DEEPSEEK_API_KEY` 环境变量
- [ ] 端口 8000 未被占用
- [ ] 网络连接正常（首次启动需下载模型）

全部完成后，运行：
```bash
cd backend
python -m uvicorn app.main:app --reload
```

或使用启动脚本：
```powershell
cd backend
.\启动服务器.ps1
```

---

**配置完成后，访问 `frontend/login.html` 开始使用！** 🎉

