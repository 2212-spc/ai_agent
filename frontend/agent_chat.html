<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph Agent - 智能体演示</title>
    
    <!-- 新增：模块化CSS -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="css/pages/agent-chat.css">
</head>
<body>
    <!-- 加载进度条 -->
    <div class="loading-progress" id="loadingProgress">
        <div class="loading-progress-bar" id="loadingProgressBar" style="width: 0%"></div>
    </div>
    
    <!-- 加载状态提示 -->
    <div class="loading-status" id="loadingStatus">
        <div class="loading-status-icon">⚙️</div>
        <div>
            <div class="loading-status-text" id="loadingStatusText">加载中...</div>
            <div class="loading-status-step" id="loadingStatusStep"></div>
        </div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="logo">🤖</div>
                <div class="header-title">
                    <h1>AI Agent Studio</h1>
                    <div class="header-title-sub">多智能体对话与知识工作台</div>
                </div>
                <div class="header-nav">
                    <div class="nav-links">
                        <a href="agent_chat.html" class="nav-link active">
                            <span>💬 对话工作台</span>
                        </a>
                        <a href="prompt_management.html" class="nav-link">
                            <span>📝 Prompt 模板</span>
                        </a>
                        <a href="knowledge_base.html" class="nav-link">
                            <span>📁 知识库</span>
                        </a>
                        <a href="conversation_history.html" class="nav-link">
                            <span>📚 会话历史</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <div class="mode-switch-container" title="切换全局/独立记忆模式">
                    <span class="mode-switch-label">记忆:</span>
                    <label class="mode-switch">
                        <input type="checkbox" id="globalMemoryToggle" onchange="toggleGlobalMemory()">
                        <span class="mode-slider"></span>
                    </label>
                    <span class="mode-indicator" id="memoryIndicator">独立记忆</span>
                </div>
                <div class="mode-switch-container" title="切换单/多智能体模式">
                    <span class="mode-switch-label">模式:</span>
                    <label class="mode-switch">
                        <input type="checkbox" id="multiAgentToggle" onchange="toggleMultiAgentMode()">
                        <span class="mode-slider"></span>
                    </label>
                    <span class="mode-indicator" id="modeIndicator">单智能体</span>
                </div>
                <div class="mode-switch-container" title="切换深度思考模式">
                    <span class="mode-switch-label">思考:</span>
                    <label class="mode-switch">
                        <input type="checkbox" id="deepThinkToggle" onchange="toggleDeepThink()">
                        <span class="mode-slider"></span>
                    </label>
                    <span class="mode-indicator" id="thinkIndicator">标准模式</span>
                </div>
                <button class="btn-icon icon-btn" id="themeToggle" onclick="toggleTheme()" title="切换主题">
                    <span id="themeIcon">🌙</span>
                </button>
                <button class="btn-icon icon-btn" onclick="openSettings()" title="会话设置">⚙️</button>
                <button class="btn-icon icon-btn" onclick="toggleBuilder()" title="Agent构建器">🛠️</button>
                <button class="btn btn-secondary btn-small" onclick="toggleTimeline()">
                    <span id="timelineToggleText">展开过程 →</span>
                </button>
                <button class="btn-icon icon-btn" onclick="clearChat()" title="清空对话">🗑️</button>
                <button class="btn-icon icon-btn" onclick="exportChat()" title="导出对话">💾</button>
                <button class="btn-icon icon-btn" onclick="logout()" title="退出登录">🚪</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- 左侧历史记录侧边栏 -->
            <div class="sidebar" id="historySidebar">
                <button class="btn btn-primary btn-small new-chat-btn" onclick="startNewChat()">
                    ➕ 新建对话
                </button>
                <div class="sidebar-header">
                    <div class="sidebar-title">📚 历史记录</div>
                    <div class="sidebar-actions">
                        <button class="btn-icon icon-btn" onclick="refreshHistoryList()" title="刷新">🔄</button>
                    </div>
                </div>
                <div class="sidebar-content" id="sidebarHistoryList">
                    <div class="history-loading">加载中...</div>
                </div>
            </div>

            <!-- 侧边栏切换按钮 -->
            <button class="toggle-sidebar-btn" id="toggleSidebarBtn" onclick="toggleSidebar()">
                ◀
            </button>

            <!-- Chat Area -->
            <div class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    <!-- 改进的空状态 -->
                    <div class="empty-state">
                        <div class="empty-illustration">🤖</div>
                        <h3>开始您的第一次对话</h3>
                        <p>我是 AI Agent，可以帮您完成复杂任务，试试下面的示例或直接提问</p>
                        <div class="quick-actions">
                            <button class="btn-quick" onclick="useExample('查询北京明天的天气，如果会下雨就写个笔记提醒我带伞')">
                                ⛅ 查天气并提醒
                            </button>
                            <button class="btn-quick" onclick="useExample('帮我搜索人工智能的最新进展，总结关键点并画个思维导图')">
                                🔍 搜索并可视化
                            </button>
                            <button class="btn-quick" onclick="useExample('查询知识库中关于MobileNet的内容，提取核心创新点')">
                                📚 查询知识库
                            </button>
                            <button class="btn-quick" onclick="document.getElementById('fileInput').click()">
                                📁 上传文档分析
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Input -->
                <div class="input-container">
                    <div class="attached-files" id="attachedFiles"></div>
                    <div class="input-wrapper">
                        <div class="input-box">
                            <textarea 
                                id="messageInput" 
                                placeholder="发送消息..."
                                rows="1"
                            ></textarea>
                            <div class="input-controls">
                                <div class="input-options-panel" id="inputOptionsPanel">
                                    <label class="option-label">
                                        <input type="checkbox" id="useKB" checked>
                                        <span>知识库</span>
                                    </label>
                                    <label class="option-label">
                                        <input type="checkbox" id="useTools" checked>
                                        <span>工具</span>
                                    </label>
                                    <button class="option-attach" onclick="document.getElementById('fileInput').click()" title="上传文件">
                                        <span>📎 上传文件</span>
                                    </button>
                                </div>
                                <button class="btn-icon" onclick="toggleInputOptions()" title="更多选项">
                                    ＋
                                </button>
                                <button class="send-btn" id="sendBtn">
                                    ↑
                                </button>
                                <button class="stop-btn" id="stopBtn" style="display: none;" title="停止生成">
                                    ⏹
                                </button>
                            </div>
                        </div>
                        <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt" onchange="handleFileSelect(event)">
                    </div>
                </div>
            </div>

            <!-- 图片放大模态框 -->
            <div id="imageModal" class="image-modal" onclick="closeImageModal()">
                <span class="image-modal-close">&times;</span>
                <img class="image-modal-content" id="modalImage">
            </div>

            <!-- Mermaid图表放大模态框 -->
            <div id="mermaidModal" class="mermaid-modal" onclick="closeMermaidModal()">
                <div class="mermaid-modal-content" onclick="event.stopPropagation()">
                    <span class="mermaid-modal-close" onclick="closeMermaidModal()">&times;</span>
                    <div id="modalMermaidContent"></div>
                </div>
            </div>

            <!-- Agent Timeline (Collapsible) -->
            <div class="agent-timeline" id="agentTimeline">
                <!-- 拖动手柄 -->
                <div class="timeline-resize-handle" id="timelineResizeHandle"></div>
                
                <div class="timeline-title">
                    <span>执行过程</span>
                    <button class="close-timeline" onclick="toggleTimeline()">✕</button>
                </div>
                <div class="timeline-filters">
                    <div class="timeline-filter-chip active" data-filter="thoughts" onclick="toggleTimelineFilter('thoughts', this)">
                        <span>思维</span>
                    </div>
                    <div class="timeline-filter-chip active" data-filter="observations" onclick="toggleTimelineFilter('observations', this)">
                        <span>观察</span>
                    </div>
                    <div class="timeline-filter-chip active" data-filter="tools" onclick="toggleTimelineFilter('tools', this)">
                        <span>工具调用</span>
                    </div>
                </div>
                <div id="timelineContent">
                    <p style="color: #9ca3af; text-align: center; padding: 40px 20px; font-size: 13px;">
                        等待任务开始...
                    </p>
                </div>

                <!-- Stats -->
                <div class="stats-bar" id="statsBar" style="display: none;">
                    <div class="stat-item">
                        <span class="stat-label">节点:</span>
                        <span class="stat-value" id="nodeCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">工具:</span>
                        <span class="stat-value" id="toolCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">评分:</span>
                        <span class="stat-value" id="qualityScore">-</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Agent构建器面板 -->
        <div class="builder-panel" id="builderPanel">
            <div class="builder-header">
                <div class="builder-title">Agent构建器</div>
                <div class="builder-actions">
                    <button class="btn btn-primary btn-small" onclick="saveAgentConfig()">💾 保存</button>
                    <button class="btn btn-secondary btn-small" onclick="testAgentConfig()">▶️ 测试</button>
                    <button class="btn btn-danger btn-small" onclick="clearBuilder()">🗑️ 清空</button>
                    <button class="btn btn-secondary btn-small" onclick="toggleBuilder()">✕ 关闭</button>
                </div>
            </div>
            <div class="builder-toolbar">
                <div class="toolbar-btn" onclick="autoLayout()" title="自动布局">
                    <span>📐</span> 自动布局
                </div>
                <div class="toolbar-btn" onclick="zoomIn()" title="放大">
                    <span>🔍+</span>
                </div>
                <div class="toolbar-btn" onclick="zoomOut()" title="缩小">
                    <span>🔍-</span>
                </div>
                <div class="toolbar-btn" onclick="resetZoom()" title="重置缩放">
                    <span>🔍</span> 重置
                </div>
                <div style="flex: 1;"></div>
                <div class="history-controls">
                    <button 
                        class="history-btn" 
                        id="undoBtn" 
                        onclick="undoBuilder()"
                        aria-label="撤销"
                        title="撤销 (Ctrl+Z)"
                    >
                        ↶ 撤销
                    </button>
                    <button 
                        class="history-btn" 
                        id="redoBtn" 
                        onclick="redoBuilder()"
                        aria-label="重做"
                        title="重做 (Ctrl+Y)"
                    >
                        ↷ 重做
                    </button>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    提示：拖拽节点移动 | 双击节点连接 | 右键删除 | Delete键删除选中节点
                </div>
            </div>
            <div class="builder-content">
                <div class="builder-sidebar">
                    <div class="node-palette">
                        <div class="palette-title">节点类型</div>
                        <div class="palette-item" draggable="true" data-type="planner" onclick="addNode('planner', '规划器')">🧠 规划器</div>
                        <div class="palette-item" draggable="true" data-type="knowledge_search" onclick="addNode('knowledge_search', '知识库检索')">📚 知识库检索</div>
                        <div class="palette-item" draggable="true" data-type="tool_executor" onclick="addNode('tool_executor', '工具执行器')">🔧 工具执行器</div>
                        <div class="palette-item" draggable="true" data-type="condition" onclick="addNode('condition', '条件判断')">🔀 条件判断</div>
                        <div class="palette-item" draggable="true" data-type="llm_call" onclick="addNode('llm_call', 'LLM调用')">💬 LLM调用</div>
                        <div class="palette-item" draggable="true" data-type="synthesizer" onclick="addNode('synthesizer', '合成器')">✨ 合成器</div>
                    </div>
                    <div class="node-palette" id="toolsPalette">
                        <div class="palette-title">可用工具</div>
                        <div id="toolsList">加载中...</div>
                    </div>
                    <div class="node-palette">
                        <div class="palette-title">示例模板</div>
                        <div class="palette-item" onclick="loadExample('weather')" style="background: #e0f2fe; border-color: #0284c7;">
                            🌤️ 天气助手示例
                        </div>
                        <div class="palette-item" onclick="loadExample('search')" style="background: #fef3c7; border-color: #f59e0b;">
                            🔍 搜索总结示例
                        </div>
                    </div>
                </div>
                <div class="builder-canvas" id="builderCanvas">
                    <!-- 画布内容层（会被缩放和平移） -->
                    <div id="canvasContentLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform-origin: 0 0; will-change: transform;">
                        <div class="builder-hint" id="builderHint">
                            <div style="font-size: 24px; margin-bottom: 8px;">🎨</div>
                            <div>从左侧拖拽节点到画布</div>
                            <div style="font-size: 12px; margin-top: 4px; color: var(--text-tertiary);">或点击节点类型快速添加</div>
                        </div>
                        <svg id="connectionSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                        </svg>
                    </div>
                    <!-- 固定层（不会被缩放） -->
                    <div class="canvas-usage-hint" id="canvasUsageHint">
                        💡 拖拽画布：<code>空格+拖动</code> 或 <code>Shift+拖动</code> 或 <code>中键拖动</code> | 缩放：<code>滚轮</code>
                    </div>
                    <div class="canvas-controls">
                        <div class="canvas-control-btn" onclick="zoomIn()" title="放大 (滚轮向上)">🔍+</div>
                        <div class="canvas-control-btn" onclick="zoomOut()" title="缩小 (滚轮向下)">🔍-</div>
                        <div class="canvas-control-btn" onclick="resetCanvasView()" title="重置视图">⟲</div>
                        <div class="canvas-control-btn" onclick="centerCanvas()" title="居中画布">🎯</div>
                    </div>
                    <div class="zoom-indicator" id="zoomIndicator">100%</div>
                </div>
                <div class="config-panel" id="configPanel">
                    <div class="config-title">节点配置</div>
                    <div id="configContent" style="color: var(--text-tertiary); font-size: 13px;">选择一个节点进行配置</div>
                </div>
            </div>
        </div>
        
        <!-- 右键菜单 -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" onclick="deleteSelectedNode()">🗑️ 删除节点</div>
            <div class="context-menu-item" onclick="duplicateNode()">📋 复制节点</div>
            <div class="context-menu-item" onclick="closeContextMenu()">✕ 取消</div>
        </div>
    </div>

    <!-- 重复的内联JavaScript代码块已删除（原3228-6968行，约3740行）
         这些代码已迁移至模块化JS文件：
         - js/canvasManager.js
         - js/chatManager.js
         - js/ui-interactions.js
         删除时间：2024-11-22 -->
    
    

    
    <!-- 新手引导遮罩 -->
    <div class="onboarding-overlay" id="onboardingOverlay">
        <div class="onboarding-spotlight" id="onboardingSpotlight"></div>
        <div class="onboarding-tooltip" id="onboardingTooltip">
            <h3 id="onboardingTitle">👋 欢迎使用 AI Agent</h3>
            <p id="onboardingDesc">让我带您快速了解主要功能...</p>
            <div class="onboarding-progress">
                <div class="onboarding-dot active"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
            </div>
            <div class="onboarding-actions">
                <button onclick="skipOnboarding()">跳过</button>
                <button onclick="nextOnboarding()">下一步 →</button>
            </div>
        </div>
    </div>
    
    <!-- 新手引导JavaScript -->
    <script>
        const onboardingSteps = [
            {
                title: '👋 欢迎使用 AI Agent',
                desc: '这是一个强大的智能助手，让我带您快速了解主要功能',
                target: null
            },
            {
                title: '💬 输入您的问题',
                desc: '在这里输入问题，按Enter键或点击发送按钮。支持多行输入（Shift+Enter）',
                target: '.input-container'
            },
            {
                title: '🧠 知识库开关',
                desc: '开启后AI会从您上传的文档中检索相关信息，提供更准确的回答',
                target: '#inputOptionsPanel'
            },
            {
                title: '📊 执行过程时间线',
                desc: '点击这里可以查看AI的思考过程和工具调用步骤',
                target: '[onclick="toggleTimeline()"]'
            }
        ];
        
        let currentStep = 0;
        
        function startOnboarding() {
            // 检查是否已经完成过引导
            if (localStorage.getItem('onboarding_completed')) {
                return;
            }
            
            setTimeout(() => {
                document.getElementById('onboardingOverlay').classList.add('active');
                updateOnboarding();
            }, 1000);
        }
        
        function updateOnboarding() {
            const step = onboardingSteps[currentStep];
            const title = document.getElementById('onboardingTitle');
            const desc = document.getElementById('onboardingDesc');
            const spotlight = document.getElementById('onboardingSpotlight');
            const tooltip = document.getElementById('onboardingTooltip');
            
            // 更新内容
            title.textContent = step.title;
            desc.textContent = step.desc;
            
            // 更新进度点
            document.querySelectorAll('.onboarding-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === currentStep);
            });
            
            // 更新按钮文字
            const nextBtn = document.querySelector('.onboarding-actions button:last-child');
            nextBtn.textContent = currentStep === onboardingSteps.length - 1 ? '开始使用 →' : '下一步 →';
            
            // 等待一帧，确保内容更新后再定位
            requestAnimationFrame(() => {
                positionTooltip(step, tooltip, spotlight);
            });
        }
        
        function positionTooltip(step, tooltip, spotlight) {
            // 高亮目标元素
            if (step.target) {
                const target = document.querySelector(step.target);
                if (target) {
                    const rect = target.getBoundingClientRect();
                    
                    // 设置spotlight
                    spotlight.style.top = rect.top - 5 + 'px';
                    spotlight.style.left = rect.left - 5 + 'px';
                    spotlight.style.width = rect.width + 10 + 'px';
                    spotlight.style.height = rect.height + 10 + 'px';
                    spotlight.style.display = 'block';
                    
                    // 智能定位tooltip
                    tooltip.style.transform = 'none'; // 重置transform
                    
                    // 先设置可见以获取真实尺寸
                    tooltip.style.opacity = '0';
                    tooltip.style.display = 'block';
                    
                    requestAnimationFrame(() => {
                        const tooltipRect = tooltip.getBoundingClientRect();
                        const viewportHeight = window.innerHeight;
                        const viewportWidth = window.innerWidth;
                        const isMobile = viewportWidth <= 768;
                        const spaceBelow = viewportHeight - rect.bottom;
                        const spaceAbove = rect.top;
                        
                        // 移除之前的箭头类
                        tooltip.classList.remove('arrow-up', 'arrow-down');
                        
                        // 判断放在上方还是下方
                        if (spaceBelow > tooltipRect.height + 40 || spaceBelow > spaceAbove) {
                            // 放在下方
                            tooltip.style.top = Math.min(rect.bottom + 20, viewportHeight - tooltipRect.height - 20) + 'px';
                            tooltip.classList.add('arrow-up'); // 箭头朝上
                        } else {
                            // 放在上方
                            tooltip.style.top = Math.max(20, rect.top - tooltipRect.height - 20) + 'px';
                            tooltip.classList.add('arrow-down'); // 箭头朝下
                        }
                        
                        // 水平定位
                        if (!isMobile) {
                            // 桌面端：居中对齐目标元素
                            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                            left = Math.max(20, Math.min(left, viewportWidth - tooltipRect.width - 20));
                            tooltip.style.left = left + 'px';
                        }
                        // 移动端通过CSS处理（left: 20px, width: calc(100% - 40px)）
                        
                        // 显示tooltip
                        tooltip.style.opacity = '1';
                        tooltip.classList.add('fade-in');
                        
                        // 确保tooltip在视口内
                        setTimeout(() => {
                            const finalRect = tooltip.getBoundingClientRect();
                            if (finalRect.bottom > viewportHeight) {
                                tooltip.style.top = Math.max(20, viewportHeight - finalRect.height - 20) + 'px';
                            }
                        }, 50);
                    });
                } else {
                    spotlight.style.display = 'none';
                }
            } else {
                spotlight.style.display = 'none';
                tooltip.style.top = '50%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
                tooltip.style.opacity = '1';
            }
        }
        
        function nextOnboarding() {
            currentStep++;
            if (currentStep >= onboardingSteps.length) {
                finishOnboarding();
            } else {
                updateOnboarding();
            }
        }
        
        function skipOnboarding() {
            if (confirm('确定要跳过新手引导吗？您可以随时在设置中重新查看。')) {
                finishOnboarding();
            }
        }
        
        function finishOnboarding() {
            document.getElementById('onboardingOverlay').classList.remove('active');
            localStorage.setItem('onboarding_completed', 'true');
            notificationManager.show('🎉 欢迎使用！随时可以在设置中重新查看引导', 'success', 3000);
        }
        
        // 页面加载完成后启动引导
        window.addEventListener('load', () => {
            startOnboarding();
        });
    </script>
    
    <!-- ========== 模块化JavaScript引入（解决代码脑裂） ========== -->
    <!-- 注意：必须按照依赖顺序引入 -->
    <script src="js/utils.js"></script>
    <script src="js/errorHandler.js"></script>
    <script src="js/canvasManager.js"></script>
    <script src="js/chatManager.js"></script>
    <script src="js/ui-interactions.js"></script>
    <script src="js/init.js"></script>
    
</body>
</html>



