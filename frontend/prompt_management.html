<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promptæ¨¡æ¿ç®¡ç† - AI Agent</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="common.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .header {
            background: var(--bg-primary);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            font-size: 24px;
        }

        .header-title-sub {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-left: 40px;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
        }

        .nav-link {
            color: #6b7280;
            text-decoration: none;
            padding: 6px 10px;
            border-radius: 999px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .nav-link span {
            font-size: 13px;
        }

        .nav-link:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .nav-link.active {
            background: #e6f4f1;
            color: #047857;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 57px);
        }

        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-primary);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-primary);
            font-weight: 600;
            color: var(--text-primary);
        }

        .agent-list {
            padding: 8px;
        }

        .agent-item {
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }

        .agent-item:hover {
            background: var(--bg-hover);
        }

        .agent-item.active {
            background: var(--primary-light);
            border-left: 3px solid var(--primary-color);
        }

        .agent-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .agent-description {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .content-header h2 {
            font-size: 24px;
            color: var(--text-primary);
        }

        .prompt-list {
            display: grid;
            gap: 16px;
        }

        .prompt-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .prompt-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .prompt-card.default {
            border-left: 4px solid #f59e0b;
        }

        .prompt-card.active {
            border-left: 4px solid #10a37f;
        }

        .prompt-card.inactive {
            opacity: 0.7;
            background: var(--bg-tertiary);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #10a37f;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .prompt-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prompt-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        .badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-default {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .prompt-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .prompt-description {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .prompt-content {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
            color: var(--text-primary);
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .prompt-meta {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .modal-close:hover {
            background: var(--bg-hover);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            min-height: 200px;
            resize: vertical;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-primary);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .loading {
            text-align: center;
            padding: 32px;
            color: var(--text-secondary);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            z-index: 2000;
            animation: slideIn 0.3s;
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--error-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <div class="logo">ğŸ¤–</div>
            <div class="header-title">
                <h1>AI Agent Studio</h1>
                <div class="header-title-sub">Prompt æ¨¡æ¿ç®¡ç†</div>
            </div>
            <div class="header-nav">
                <div class="nav-links">
                    <a href="agent_chat.html" class="nav-link">
                        <span>ğŸ’¬ å¯¹è¯å·¥ä½œå°</span>
                    </a>
                    <a href="prompt_management.html" class="nav-link active">
                        <span>ğŸ“ Prompt æ¨¡æ¿</span>
                    </a>
                    <a href="knowledge_base.html" class="nav-link">
                        <span>ğŸ“ çŸ¥è¯†åº“</span>
                    </a>
                    <a href="conversation_history.html" class="nav-link">
                        <span>ğŸ“š ä¼šè¯å†å²</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-icon" id="themeToggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span id="themeIcon">ğŸŒ™</span>
            </button>
            <a href="agent_chat.html" class="btn btn-secondary">è¿”å›èŠå¤©</a>
        </div>
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§ï¼šæ™ºèƒ½ä½“åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">æ™ºèƒ½ä½“åˆ—è¡¨</div>
            <div class="agent-list" id="agentList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šPromptæ¨¡æ¿åˆ—è¡¨ -->
        <div class="content-area">
            <div class="content-header">
                <h2 id="selectedAgentName">è¯·é€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“</h2>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" id="generatePromptBtn" style="display: none;" onclick="openGenerateModal()">
                        âœ¨ æ™ºèƒ½ç”Ÿæˆ
                    </button>
                    <button class="btn btn-primary" id="createPromptBtn" style="display: none;">
                        â• åˆ›å»ºæ–°æ¨¡æ¿
                    </button>
                </div>
            </div>
            <div id="promptList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘ˆ</div>
                    <div>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“æŸ¥çœ‹å…¶Promptæ¨¡æ¿</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘æ¨¡æ¿çš„æ¨¡æ€æ¡† -->
    <div class="modal" id="promptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">åˆ›å»ºPromptæ¨¡æ¿</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="promptForm">
                    <input type="hidden" id="templateId">
                    
                    <div class="form-group">
                        <label class="form-label">æ¨¡æ¿åç§° *</label>
                        <input type="text" class="form-input" id="templateName" required>
                        <div class="form-hint">ä¸ºè¿™ä¸ªæ¨¡æ¿èµ·ä¸€ä¸ªå®¹æ˜“è¯†åˆ«çš„åç§°</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ‰€å±æ™ºèƒ½ä½“ *</label>
                        <select class="form-select" id="templateAgentId" required>
                            <option value="">è¯·é€‰æ‹©æ™ºèƒ½ä½“</option>
                        </select>
                        <div class="form-hint">é€‰æ‹©è¿™ä¸ªæ¨¡æ¿è¦åº”ç”¨åˆ°çš„æ™ºèƒ½ä½“</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨¡æ¿æè¿°</label>
                        <input type="text" class="form-input" id="templateDescription" placeholder="å¯é€‰ï¼Œæè¿°è¿™ä¸ªæ¨¡æ¿çš„ç”¨é€”">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Promptå†…å®¹ *</label>
                        <textarea class="form-textarea" id="templateContent" required placeholder="è¾“å…¥Promptå†…å®¹..."></textarea>
                        <div class="form-hint">å¯ä»¥ä½¿ç”¨ {user_query}ã€{task_description} ç­‰å ä½ç¬¦ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ›¿æ¢</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="savePrompt()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ™ºèƒ½ç”ŸæˆPromptæ¨¡æ€æ¡† -->
    <div class="modal" id="generateModal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>âœ¨ æ™ºèƒ½ç”ŸæˆPrompt</h3>
                <button class="modal-close" onclick="closeGenerateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0; color: #1e40af; font-size: 14px;">
                        ğŸ’¡ <strong>æç¤º</strong>ï¼šåªéœ€ç”¨è‡ªç„¶è¯­è¨€æè¿°ä½ çš„éœ€æ±‚ï¼ŒAIä¼šè‡ªåŠ¨ç”Ÿæˆä¸“ä¸šçš„Promptæ¨¡æ¿ã€‚
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ™ºèƒ½ä½“</label>
                    <input type="text" class="form-input" id="generateAgentName" readonly 
                           style="background: #f3f4f6; cursor: not-allowed;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ä½ çš„éœ€æ±‚ <span style="color: red;">*</span></label>
                    <textarea class="form-textarea" id="generateRequirement" rows="5" 
                              placeholder="ä¾‹å¦‚ï¼šæˆ‘éœ€è¦ä¸€ä¸ªèƒ½åˆ†ææ•°æ®çš„ä¸“å®¶ï¼Œè¦æ±‚è¾“å‡ºç»“æ„åŒ–JSONæ ¼å¼ï¼ŒåŒ…å«å…³é”®æŒ‡æ ‡å’Œè¶‹åŠ¿åˆ†æ..."></textarea>
                    <div class="form-hint">è¯¦ç»†æè¿°ä½ å¸Œæœ›è¿™ä¸ªæ™ºèƒ½ä½“åšä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆç‰¹æ®Šè¦æ±‚</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å‚è€ƒé£æ ¼ï¼ˆå¯é€‰ï¼‰</label>
                    <select class="form-select" id="generateStyle">
                        <option value="">é»˜è®¤</option>
                        <option value="ç®€æ´">ç®€æ´</option>
                        <option value="è¯¦ç»†">è¯¦ç»†</option>
                        <option value="ä¸“ä¸š">ä¸“ä¸š</option>
                        <option value="å‹å¥½">å‹å¥½</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¾“å‡ºæ ¼å¼ï¼ˆå¯é€‰ï¼‰</label>
                    <select class="form-select" id="generateFormat">
                        <option value="">é»˜è®¤</option>
                        <option value="JSON">JSON</option>
                        <option value="Markdown">Markdown</option>
                        <option value="çº¯æ–‡æœ¬">çº¯æ–‡æœ¬</option>
                        <option value="ç»“æ„åŒ–åˆ—è¡¨">ç»“æ„åŒ–åˆ—è¡¨</option>
                    </select>
                </div>
                
                <div id="generateResult" style="display: none; margin-top: 20px;">
                    <!-- éªŒè¯ç»“æœæç¤º -->
                    <div id="validationResult" style="margin-bottom: 16px;"></div>
                    
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <strong>ç”Ÿæˆçš„Promptï¼š</strong>
                            <button class="btn btn-small btn-secondary" onclick="copyGeneratedPrompt()">ğŸ“‹ å¤åˆ¶</button>
                        </div>
                        <pre id="generatedPromptContent" style="background: white; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 300px; overflow-y: auto; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;"></pre>
                    </div>
                    
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="saveGeneratedPrompt()">
                            ğŸ’¾ ä¿å­˜ä¸ºæ¨¡æ¿
                        </button>
                        <button class="btn btn-secondary" onclick="regeneratePrompt()">
                            ğŸ”„ é‡æ–°ç”Ÿæˆ
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGenerateModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="generatePrompt()" id="generateBtn">
                    âœ¨ ç”ŸæˆPrompt
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ==========
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            showToast(newTheme === 'dark' ? 'ğŸŒ™ å·²åˆ‡æ¢åˆ°æš—è‰²æ¨¡å¼' : 'â˜€ï¸ å·²åˆ‡æ¢åˆ°äº®è‰²æ¨¡å¼', 'success');
        }
        
        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
        initTheme();

        const API_BASE = 'http://localhost:8000';
        let agents = [];
        let currentAgentId = null;
        let prompts = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        async function init() {
            // é¦–å…ˆåˆå§‹åŒ–é»˜è®¤æ¨¡æ¿ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            await initDefaultPrompts();
            await loadAgents();
            await loadPrompts();
        }

        // åˆå§‹åŒ–é»˜è®¤æ¨¡æ¿
        async function initDefaultPrompts() {
            try {
                const response = await fetch(`${API_BASE}/prompts/init-defaults`, {
                    method: 'POST',
                });
                if (response.ok) {
                    const result = await response.json();
                    console.log('é»˜è®¤æ¨¡æ¿åˆå§‹åŒ–:', result.message);
                }
            } catch (error) {
                console.warn('åˆå§‹åŒ–é»˜è®¤æ¨¡æ¿å¤±è´¥:', error);
                // ä¸å½±å“é¡µé¢åŠ è½½ï¼Œç»§ç»­æ‰§è¡Œ
            }
        }

        // åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨
        async function loadAgents() {
            try {
                const response = await fetch(`${API_BASE}/agents/list`);
                if (!response.ok) throw new Error('åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨å¤±è´¥');
                agents = await response.json();
                renderAgents();
            } catch (error) {
                showToast('error', 'åŠ è½½æ™ºèƒ½ä½“åˆ—è¡¨å¤±è´¥: ' + error.message);
                document.getElementById('agentList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“æ™ºèƒ½ä½“åˆ—è¡¨
        function renderAgents() {
            const container = document.getElementById('agentList');
            if (agents.length === 0) {
                container.innerHTML = '<div class="empty-state">æ²¡æœ‰å¯ç”¨çš„æ™ºèƒ½ä½“</div>';
                return;
            }

            container.innerHTML = agents.map(agent => `
                <div class="agent-item ${currentAgentId === agent.id ? 'active' : ''}" 
                     onclick="selectAgent('${agent.id}')">
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-description">${agent.description || 'æ— æè¿°'}</div>
                </div>
            `).join('');
        }

        // é€‰æ‹©æ™ºèƒ½ä½“
        async function selectAgent(agentId) {
            currentAgentId = agentId;
            renderAgents();
            
            const agent = agents.find(a => a.id === agentId);
            document.getElementById('selectedAgentName').textContent = agent ? agent.name : 'æœªçŸ¥æ™ºèƒ½ä½“';
            document.getElementById('createPromptBtn').style.display = 'block';
            document.getElementById('generatePromptBtn').style.display = 'block';
            
            await loadPrompts(agentId);
        }

        // åŠ è½½Promptæ¨¡æ¿åˆ—è¡¨
        async function loadPrompts(agentId = null) {
            try {
                const url = agentId 
                    ? `${API_BASE}/prompts/agent/${agentId}?include_inactive=true`
                    : `${API_BASE}/prompts?include_inactive=true`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('åŠ è½½Promptæ¨¡æ¿å¤±è´¥');
                prompts = await response.json();
                renderPrompts();
            } catch (error) {
                showToast('error', 'åŠ è½½Promptæ¨¡æ¿å¤±è´¥: ' + error.message);
                prompts = [];
                renderPrompts();
            }
        }

        // æ¸²æŸ“Promptæ¨¡æ¿åˆ—è¡¨
        function renderPrompts() {
            const container = document.getElementById('promptList');
            
            if (!currentAgentId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘ˆ</div>
                        <div>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“æŸ¥çœ‹å…¶Promptæ¨¡æ¿</div>
                    </div>
                `;
                return;
            }

            const agentPrompts = prompts.filter(p => p.agent_id === currentAgentId);
            
            if (agentPrompts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>è¯¥æ™ºèƒ½ä½“è¿˜æ²¡æœ‰Promptæ¨¡æ¿</div>
                        <div style="margin-top: 12px;">
                            <button class="btn btn-primary" onclick="openCreateModal()">åˆ›å»ºç¬¬ä¸€ä¸ªæ¨¡æ¿</button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = agentPrompts.map(prompt => `
                <div class="prompt-card card card-hoverable ${prompt.is_default ? 'default' : ''} ${prompt.is_active ? 'active' : 'inactive'}">
                    <div class="prompt-header">
                        <div class="prompt-title">
                            <span class="prompt-name">${escapeHtml(prompt.name)}</span>
                            ${prompt.is_default ? '<span class="badge badge-default">é»˜è®¤æ¨¡æ¿</span>' : ''}
                            ${prompt.is_active ? '<span class="badge badge-active">å·²æ¿€æ´»</span>' : '<span class="badge" style="background: #9ca3af; color: white;">å·²åœç”¨</span>'}
                        </div>
                        <div class="prompt-actions">
                            <label class="toggle-label">
                                <span>${prompt.is_active ? 'æ¿€æ´»' : 'åœç”¨'}</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${prompt.is_active ? 'checked' : ''} 
                                           ${prompt.is_default ? 'title="é»˜è®¤æ¨¡æ¿ï¼šéœ€è¦å…ˆæ¿€æ´»å…¶ä»–æ¨¡æ¿æ‰èƒ½åœç”¨"' : ''}
                                           onchange="togglePromptStatus('${prompt.id}', this.checked, ${prompt.is_default})">
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                            ${!prompt.is_default ? `<button class="btn btn-secondary btn-small" onclick="openEditModal('${prompt.id}')">ç¼–è¾‘</button>` : ''}
                            ${!prompt.is_default ? `<button class="btn btn-danger btn-small" onclick="deletePrompt('${prompt.id}')">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                    ${prompt.description ? `<div class="prompt-description">${escapeHtml(prompt.description)}</div>` : ''}
                    <div class="prompt-content">${escapeHtml(prompt.content)}</div>
                    <div class="prompt-meta">
                        <span>åˆ›å»ºæ—¶é—´: ${formatDate(prompt.created_at)}</span>
                        <span>æ›´æ–°æ—¶é—´: ${formatDate(prompt.updated_at)}</span>
                    </div>
                </div>
            `).join('');
        }

        // æ‰“å¼€åˆ›å»ºæ¨¡æ¿æ¨¡æ€æ¡†
        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºPromptæ¨¡æ¿';
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
            document.getElementById('templateContent').value = '';
            
            // è®¾ç½®å½“å‰é€‰ä¸­çš„æ™ºèƒ½ä½“
            const agentSelect = document.getElementById('templateAgentId');
            agentSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ™ºèƒ½ä½“</option>' +
                agents.map(agent => `<option value="${agent.id}" ${agent.id === currentAgentId ? 'selected' : ''}>${agent.name}</option>`).join('');
            
            document.getElementById('promptModal').classList.add('active');
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ¿æ¨¡æ€æ¡†
        async function openEditModal(templateId) {
            const prompt = prompts.find(p => p.id === templateId);
            if (!prompt) {
                showToast('error', 'æ‰¾ä¸åˆ°è¯¥æ¨¡æ¿');
                return;
            }

            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘Promptæ¨¡æ¿';
            document.getElementById('templateId').value = prompt.id;
            document.getElementById('templateName').value = prompt.name;
            document.getElementById('templateDescription').value = prompt.description || '';
            document.getElementById('templateContent').value = prompt.content;
            
            // è®¾ç½®æ™ºèƒ½ä½“é€‰æ‹©ï¼ˆç¼–è¾‘æ—¶ä¸å¯æ›´æ”¹ï¼‰
            const agentSelect = document.getElementById('templateAgentId');
            agentSelect.innerHTML = `<option value="${prompt.agent_id}" selected>${agents.find(a => a.id === prompt.agent_id)?.name || prompt.agent_id}</option>`;
            agentSelect.disabled = true;
            
            document.getElementById('promptModal').classList.add('active');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('promptModal').classList.remove('active');
            document.getElementById('templateAgentId').disabled = false;
        }

        // ä¿å­˜Promptæ¨¡æ¿
        async function savePrompt() {
            const form = document.getElementById('promptForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const templateId = document.getElementById('templateId').value;
            const data = {
                name: document.getElementById('templateName').value,
                agent_id: document.getElementById('templateAgentId').value,
                content: document.getElementById('templateContent').value,
                description: document.getElementById('templateDescription').value || null,
            };

            try {
                let response;
                if (templateId) {
                    // æ›´æ–°
                    response = await fetch(`${API_BASE}/prompts/${templateId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                } else {
                    // åˆ›å»º
                    response = await fetch(`${API_BASE}/prompts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ä¿å­˜å¤±è´¥');
                }

                showToast('success', templateId ? 'æ¨¡æ¿æ›´æ–°æˆåŠŸ' : 'æ¨¡æ¿åˆ›å»ºæˆåŠŸ');
                closeModal();
                await loadPrompts(currentAgentId);
            } catch (error) {
                showToast('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢Promptæ¨¡æ¿æ¿€æ´»çŠ¶æ€
        async function togglePromptStatus(templateId, isActive, isDefault = false) {
            try {
                let response;
                if (isActive) {
                    // æ¿€æ´»æ¨¡æ¿ï¼ˆä¼šè‡ªåŠ¨åœç”¨å…¶ä»–æ¨¡æ¿ï¼‰
                    const confirmMsg = isDefault 
                        ? 'ç¡®å®šè¦æ¿€æ´»é»˜è®¤æ¨¡æ¿å—ï¼Ÿæ¿€æ´»åï¼Œè¯¥æ™ºèƒ½ä½“çš„å…¶ä»–æ¨¡æ¿å°†è‡ªåŠ¨è®¾ä¸ºéæ¿€æ´»çŠ¶æ€ã€‚'
                        : 'ç¡®å®šè¦æ¿€æ´»è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿæ¿€æ´»åï¼Œè¯¥æ™ºèƒ½ä½“çš„å…¶ä»–æ¨¡æ¿å°†è‡ªåŠ¨è®¾ä¸ºéæ¿€æ´»çŠ¶æ€ã€‚';
                    
                    if (!confirm(confirmMsg)) {
                        // å¦‚æœå–æ¶ˆï¼Œéœ€è¦æ¢å¤å¼€å…³çŠ¶æ€
                        await loadPrompts(currentAgentId);
                        return;
                    }
                    response = await fetch(`${API_BASE}/prompts/${templateId}/activate`, {
                        method: 'POST',
                    });
                } else {
                    // åœç”¨æ¨¡æ¿
                    const confirmMsg = isDefault
                        ? 'ç¡®å®šè¦åœç”¨é»˜è®¤æ¨¡æ¿å—ï¼Ÿåœç”¨å‰è¯·ç¡®ä¿è¯¥æ™ºèƒ½ä½“è‡³å°‘æœ‰ä¸€ä¸ªå…¶ä»–æ¿€æ´»çš„æ¨¡æ¿ï¼Œå¦åˆ™ç³»ç»Ÿå°†ä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤promptã€‚'
                        : 'ç¡®å®šè¦åœç”¨è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿåœç”¨åè¯¥æ¨¡æ¿å°†ä¸ä¼šè¢«ä½¿ç”¨ã€‚';
                    
                    if (!confirm(confirmMsg)) {
                        // å¦‚æœå–æ¶ˆï¼Œéœ€è¦æ¢å¤å¼€å…³çŠ¶æ€
                        await loadPrompts(currentAgentId);
                        return;
                    }
                    response = await fetch(`${API_BASE}/prompts/${templateId}/deactivate`, {
                        method: 'POST',
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || (isActive ? 'æ¿€æ´»å¤±è´¥' : 'åœç”¨å¤±è´¥'));
                }

                showToast('success', isActive ? 'æ¨¡æ¿æ¿€æ´»æˆåŠŸ' : 'æ¨¡æ¿å·²åœç”¨');
                await loadPrompts(currentAgentId);
            } catch (error) {
                showToast('error', (isActive ? 'æ¿€æ´»' : 'åœç”¨') + 'å¤±è´¥: ' + error.message);
                // å‘ç”Ÿé”™è¯¯æ—¶é‡æ–°åŠ è½½ä»¥æ¢å¤æ­£ç¡®çš„çŠ¶æ€
                await loadPrompts(currentAgentId);
            }
        }

        // æ¿€æ´»Promptæ¨¡æ¿ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        async function activatePrompt(templateId) {
            await togglePromptStatus(templateId, true);
        }

        // åˆ é™¤Promptæ¨¡æ¿
        async function deletePrompt(templateId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/prompts/${templateId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'åˆ é™¤å¤±è´¥');
                }

                showToast('success', 'æ¨¡æ¿åˆ é™¤æˆåŠŸ');
                await loadPrompts(currentAgentId);
            } catch (error) {
                showToast('error', 'åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ç»‘å®šåˆ›å»ºæŒ‰é’®äº‹ä»¶
        document.getElementById('createPromptBtn').addEventListener('click', openCreateModal);

        // ==================== æ™ºèƒ½ç”ŸæˆPromptåŠŸèƒ½ ====================
        let currentGeneratedPrompt = null;

        // æ‰“å¼€ç”Ÿæˆæ¨¡æ€æ¡†
        function openGenerateModal() {
            if (!currentAgentId) {
                showToast('warning', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“');
                return;
            }
            
            const agent = agents.find(a => a.id === currentAgentId);
            document.getElementById('generateAgentName').value = agent ? agent.name : 'æœªçŸ¥';
            document.getElementById('generateRequirement').value = '';
            document.getElementById('generateStyle').value = '';
            document.getElementById('generateFormat').value = '';
            document.getElementById('generateResult').style.display = 'none';
            currentGeneratedPrompt = null;
            
            document.getElementById('generateModal').style.display = 'block';
        }

        // å…³é—­ç”Ÿæˆæ¨¡æ€æ¡†
        function closeGenerateModal() {
            document.getElementById('generateModal').style.display = 'none';
        }

        // ç”ŸæˆPrompt
        async function generatePrompt() {
            const requirement = document.getElementById('generateRequirement').value.trim();
            if (!requirement) {
                showToast('error', 'è¯·è¾“å…¥ä½ çš„éœ€æ±‚');
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                const response = await fetch(`${API_BASE}/prompts/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent_id: currentAgentId,
                        user_requirement: requirement,
                        reference_style: document.getElementById('generateStyle').value || null,
                        output_format: document.getElementById('generateFormat').value || null,
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ç”Ÿæˆå¤±è´¥');
                }
                
                const result = await response.json();
                currentGeneratedPrompt = result;
                
                // æ˜¾ç¤ºç”Ÿæˆç»“æœ
                document.getElementById('generatedPromptContent').textContent = result.generated_prompt;
                document.getElementById('generateResult').style.display = 'block';
                
                // æ˜¾ç¤ºéªŒè¯ç»“æœ
                displayValidationResult(result.validation);
                
                showToast('success', 'Promptç”ŸæˆæˆåŠŸï¼');
                
            } catch (error) {
                showToast('error', 'ç”Ÿæˆå¤±è´¥: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'âœ¨ ç”ŸæˆPrompt';
            }
        }

        // å¤åˆ¶ç”Ÿæˆçš„Prompt
        function copyGeneratedPrompt() {
            if (!currentGeneratedPrompt) return;
            
            const text = currentGeneratedPrompt.generated_prompt;
            navigator.clipboard.writeText(text).then(() => {
                showToast('success', 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                showToast('error', 'å¤åˆ¶å¤±è´¥');
            });
        }

        // ä¿å­˜ç”Ÿæˆçš„Prompt
        async function saveGeneratedPrompt() {
            if (!currentGeneratedPrompt) return;
            
            const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°ï¼š', currentGeneratedPrompt.suggested_name);
            if (!name) return;
            
            const description = prompt('è¯·è¾“å…¥æ¨¡æ¿æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š', currentGeneratedPrompt.suggested_description || '');
            
            try {
                const response = await fetch(`${API_BASE}/prompts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        agent_id: currentGeneratedPrompt.agent_id,
                        content: currentGeneratedPrompt.generated_prompt,
                        description: description || null,
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ä¿å­˜å¤±è´¥');
                }
                
                showToast('success', 'æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
                closeGenerateModal();
                await loadPrompts(currentAgentId);
                
            } catch (error) {
                showToast('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // é‡æ–°ç”Ÿæˆ
        function regeneratePrompt() {
            document.getElementById('generateResult').style.display = 'none';
            generatePrompt();
        }

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        function displayValidationResult(validation) {
            const container = document.getElementById('validationResult');
            if (!validation) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            // æ˜¾ç¤ºé—®é¢˜ï¼ˆissuesï¼‰
            if (validation.issues && validation.issues.length > 0) {
                html += `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="color: #dc2626; font-weight: 600;">âš ï¸ å‘ç°é—®é¢˜</span>
                        </div>
                        <ul style="margin: 0; padding-left: 20px; color: #991b1b;">
                            ${validation.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºè­¦å‘Šï¼ˆwarningsï¼‰
            if (validation.warnings && validation.warnings.length > 0) {
                html += `
                    <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="color: #d97706; font-weight: 600;">ğŸ’¡ å»ºè®®</span>
                        </div>
                        <ul style="margin: 0; padding-left: 20px; color: #92400e;">
                            ${validation.warnings.map(warning => `<li>${warning}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºéªŒè¯é€šè¿‡
            if (validation.valid && (!validation.issues || validation.issues.length === 0)) {
                html += `
                    <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #16a34a; font-weight: 600;">âœ… éªŒè¯é€šè¿‡</span>
                        </div>
                        <div style="margin-top: 8px; color: #166534; font-size: 14px;">
                            å ä½ç¬¦æ£€æŸ¥ï¼š${validation.placeholders_found?.length || 0} ä¸ªï¼Œæ ¼å¼è¦æ±‚ï¼šå·²æ»¡è¶³
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>

